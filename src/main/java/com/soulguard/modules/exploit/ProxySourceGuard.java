package com.soulguard.modules.exploit;

import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerPreLoginEvent;

import com.soulguard.SoulGuard;
import com.soulguard.api.SecurityModule;
import com.soulguard.util.ColorUtil;

/**
 * Ensures that if the server is intended to be behind a proxy (Bungee/Velocity),
 * connections MUST come from the proxy IP and not directly.
 */
public class ProxySourceGuard implements SecurityModule, Listener {

    private final SoulGuard plugin;
    private boolean enabled;
    private java.util.List<String> trustedProxies;

    public ProxySourceGuard(SoulGuard plugin) {
        this.plugin = plugin;
    }

    @Override
    public String getName() {
        return "ProxySourceGuard";
    }

    @Override
    public boolean isEnabled() {
        return enabled;
    }

    @Override
    public void enable() {
        this.enabled = true;
        reload();
    }

    @Override
    public void disable() {
        this.enabled = false;
    }

    @Override
    public void reload() {
        this.trustedProxies = plugin.getConfig().getStringList("modules.ProxySourceGuard.trusted-proxies");
    }

    @EventHandler(priority = EventPriority.LOWEST)
    public void onPreLogin(AsyncPlayerPreLoginEvent event) {
        if (!enabled || trustedProxies.isEmpty()) return;

        String ip = event.getAddress().getHostAddress();
        
        // If not from a trusted proxy, block direct connection attempt
        if (!trustedProxies.contains(ip)) {
            event.disallow(AsyncPlayerPreLoginEvent.Result.KICK_OTHER, 
                ColorUtil.translate("&c[SoulGuard] Direct connections are forbidden.\n&7Please connect through play.server.com"));
            plugin.getLogManager().logWarn("Blocked direct connection attempt from: " + ip);
        }
    }
}
