package com.skguard.modules.exploit;

import java.util.HashMap;
import java.util.Map;

import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityPickupItemEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;

import com.skguard.SKGuard;
import com.skguard.api.SecurityModule;
import com.skguard.util.ColorUtil;

public class IllegalItemsModule implements SecurityModule, Listener {

    private final SKGuard plugin;
    private boolean enabled;
    private String action;
    private boolean alerts;
    private final Map<Enchantment, Integer> maxLevels = new HashMap<>();

    public IllegalItemsModule(SKGuard plugin) {
        this.plugin = plugin;
    }

    @Override
    public String getName() {
        return "IllegalItemsModule";
    }

    @Override
    public boolean isEnabled() {
        return enabled;
    }

    @Override
    public void enable() {
        this.enabled = true;
        reload();
    }

    @Override
    public void disable() {
        this.enabled = false;
        maxLevels.clear();
    }

    @Override
    public void reload() {
        String path = "modules.illegal-items.";
        this.enabled = plugin.getConfig().getBoolean(path + "enabled", true);
        this.action = plugin.getConfig().getString(path + "action", "REMOVE");
        this.alerts = plugin.getConfig().getBoolean(path + "alerts", true);

        org.bukkit.configuration.ConfigurationSection enchSection = plugin.getConfig().getConfigurationSection(path + "enchantments");
        if (enchSection != null) {
            for (String key : enchSection.getKeys(false)) {
                @SuppressWarnings("deprecation")
                Enchantment ench = Enchantment.getByName(key.toUpperCase());
                if (ench != null) {
                    maxLevels.put(ench, enchSection.getInt(key));
                }
            }
        }
    }

    @EventHandler
    public void onPickup(EntityPickupItemEvent event) {
        if (!enabled || !(event.getEntity() instanceof Player player)) return;
        checkItem(player, event.getItem().getItemStack());
    }

    @EventHandler
    public void onInventoryClick(InventoryClickEvent event) {
        if (!enabled || !(event.getWhoClicked() instanceof Player)) return;
        checkItem((Player) event.getWhoClicked(), event.getCurrentItem());
    }

    @EventHandler
    public void onInteract(PlayerInteractEvent event) {
        if (!enabled) return;
        checkItem(event.getPlayer(), event.getItem());
    }

    private void checkItem(Player player, ItemStack item) {
        if (item == null || item.getType() == org.bukkit.Material.AIR) return;
        ItemMeta meta = item.getItemMeta();
        if (meta == null) return;

        boolean illegal = false;
        
        // 1. Enchantment Validation
        if (meta.hasEnchants()) {
            for (Map.Entry<Enchantment, Integer> entry : meta.getEnchants().entrySet()) {
                Enchantment ench = entry.getKey();
                int level = entry.getValue();
                int max = maxLevels.getOrDefault(ench, ench.getMaxLevel());

                if (level > max) {
                    illegal = true;
                    item.removeEnchantment(ench);
                }
            }
        }

        // 2. Attribute Validation (Premium)
        if (meta.hasAttributeModifiers()) {
            for (org.bukkit.attribute.Attribute attr : org.bukkit.attribute.Attribute.values()) {
                java.util.Collection<org.bukkit.attribute.AttributeModifier> mods = meta.getAttributeModifiers(attr);
                if (mods != null) {
                    for (org.bukkit.attribute.AttributeModifier mod : mods) {
                        if (Math.abs(mod.getAmount()) > 2048.0) { // Absurdly high values
                            illegal = true;
                            meta.removeAttributeModifier(attr);
                            break;
                        }
                    }
                }
            }
        }

        // 3. Stacking & Quantity
        if (item.getAmount() > item.getMaxStackSize() || item.getAmount() < 0) {
            illegal = true;
            item.setAmount(Math.min(item.getAmount(), item.getMaxStackSize()));
        }

        if (illegal) {
            item.setItemMeta(meta);
            handleIllegal(player);
        }
    }

    private void handleIllegal(Player player) {
        if (alerts) {
            String msg = plugin.getLanguageManager().getMessage("illegal-items.detected")
                    .replace("{player}", player.getName())
                    .replace("{action}", action);
            notifyStaff(msg);
        }

        player.sendMessage(plugin.getLanguageManager().getMessage("illegal-items.notify-player"));

        if (action.equalsIgnoreCase("REMOVE")) {
            // Item already modified in checkItem
        } else if (action.equalsIgnoreCase("KICK")) {
            player.kickPlayer(plugin.getLanguageManager().getMessage("illegal-items.notify-player"));
        } else if (action.equalsIgnoreCase("BAN")) {
            plugin.getServer().dispatchCommand(plugin.getServer().getConsoleSender(), "ban " + player.getName() + " Illegal Items");
        }
    }

    private void notifyStaff(String msg) {
        for (Player p : plugin.getServer().getOnlinePlayers()) {
            if (p.hasPermission("SKGuard.admin")) {
                p.sendMessage(ColorUtil.translate(msg));
            }
        }
    }
}

